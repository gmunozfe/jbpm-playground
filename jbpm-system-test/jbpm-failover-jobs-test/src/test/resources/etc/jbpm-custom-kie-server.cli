embed-server --server-config=standalone-full-kie-server.xml

/subsystem=logging/logger=org.jbpm.executor/:add(level=TRACE,use-parent-handlers=true)
/subsystem=logging/logger=org.kie.server.services.jbpm.cluster/:add(level=TRACE,use-parent-handlers=true)
/subsystem=logging/console-handler=CONSOLE:write-attribute(name=level, value=TRACE)

/subsystem=io/worker=default/:write-attribute(name=task-max-threads,value=1000)

## Configuring failover for jobs 
/extension=org.jboss.as.clustering.jgroups:add

batch
/socket-binding-group=standard-sockets/socket-binding=jgroups-mping:add(port=0,multicast-address=${jboss.default.multicast.address:230.0.0.4},multicast-port=45700)
/socket-binding-group=standard-sockets/socket-binding=jgroups-tcp:add(port=7600)
/socket-binding-group=standard-sockets/socket-binding=jgroups-tcp-fd:add(port=57600)
/socket-binding-group=standard-sockets/socket-binding=jgroups-udp:add(port=55200,multicast-address=${jboss.default.multicast.address:230.0.0.4},multicast-port=45688)
/socket-binding-group=standard-sockets/socket-binding=jgroups-udp-fd:add(port=54200)

/subsystem=jgroups:add(default-channel=ee,default-stack=udp)
/subsystem=jgroups/channel=ee:add(cluster=ejb)
/subsystem=jgroups/stack=udp:add
/subsystem=jgroups/stack=udp/transport=UDP:add(socket-binding=jgroups-udp)
/subsystem=jgroups/stack=udp/protocol=PING:add
/subsystem=jgroups/stack=udp/protocol=MERGE3:add
/subsystem=jgroups/stack=udp/protocol=FD_SOCK:add(socket-binding=jgroups-udp-fd)
/subsystem=jgroups/stack=udp/protocol=FD_ALL:add
/subsystem=jgroups/stack=udp/protocol=VERIFY_SUSPECT:add
/subsystem=jgroups/stack=udp/protocol=pbcast.NAKACK2:add
/subsystem=jgroups/stack=udp/protocol=UNICAST3:add
/subsystem=jgroups/stack=udp/protocol=pbcast.STABLE:add
/subsystem=jgroups/stack=udp/protocol=pbcast.GMS:add
/subsystem=jgroups/stack=udp/protocol=UFC:add
/subsystem=jgroups/stack=udp/protocol=MFC:add
/subsystem=jgroups/stack=udp/protocol=FRAG3:add

/subsystem=jgroups/stack=tcp:add
/subsystem=jgroups/stack=tcp/transport=TCP:add(socket-binding=jgroups-tcp)
/subsystem=jgroups/stack=tcp/protocol=MPING:add(socket-binding=jgroups-mping)
/subsystem=jgroups/stack=tcp/protocol=MERGE3:add
/subsystem=jgroups/stack=tcp/protocol=FD_SOCK:add(socket-binding=jgroups-tcp-fd)
/subsystem=jgroups/stack=tcp/protocol=FD:add
/subsystem=jgroups/stack=tcp/protocol=VERIFY_SUSPECT:add
/subsystem=jgroups/stack=tcp/protocol=pbcast.NAKACK2:add
/subsystem=jgroups/stack=tcp/protocol=UNICAST3:add
/subsystem=jgroups/stack=tcp/protocol=pbcast.STABLE:add
/subsystem=jgroups/stack=tcp/protocol=pbcast.GMS:add
/subsystem=jgroups/stack=tcp/protocol=MFC:add
/subsystem=jgroups/stack=tcp/protocol=FRAG3:add
run-batch

batch
/subsystem=infinispan/cache-container=jbpm:add(statistics-enabled=true)
/subsystem=infinispan/cache-container=jbpm/transport=TRANSPORT:add(lock-timeout=60000)
/subsystem=infinispan/cache-container=jbpm/replicated-cache=nodes:add()
/subsystem=infinispan/cache-container=jbpm/replicated-cache=nodes/transaction=TRANSACTION:add(mode=BATCH)
/subsystem=infinispan/cache-container=jbpm/replicated-cache=nodes:write-attribute(name=statistics-enabled,value=true)
/subsystem=infinispan/cache-container=jbpm/replicated-cache=jobs:add()
/subsystem=infinispan/cache-container=jbpm/replicated-cache=jobs/transaction=TRANSACTION:add(mode=BATCH)
/subsystem=infinispan/cache-container=jbpm/replicated-cache=jobs:write-attribute(name=statistics-enabled,value=true)
run-batch

/interface=private:add(inet-address=${jboss.bind.address:127.0.0.1})

# Adding postgresql driver as a core module
module add --name=com.postgresql --resources=/etc/drivers/postgresql.jar --dependencies=javax.api,javax.transaction.api

/subsystem=datasources/jdbc-driver=postgresql:add(driver-name=postgresql,driver-module-name=com.postgresql,\
driver-xa-datasource-class-name=org.postgresql.xa.PGXADataSource)

xa-data-source add --name=rhpamXADS --jndi-name=java:/rhpamXADS --driver-name=postgresql --user-name=rhpamuser \
--password=rhpampassword --validate-on-match=true --background-validation=false \
--valid-connection-checker-class-name=org.jboss.jca.adapters.jdbc.extensions.postgres.PostgreSQLValidConnectionChecker \
--exception-sorter-class-name=org.jboss.jca.adapters.jdbc.extensions.postgres.PostgreSQLExceptionSorter \
--xa-datasource-properties={"ServerName"=>"postgresql11","PortNumber"=>"5432","DatabaseName"=>"rhpamdatabase"}

#Configure postgresql as kieserver persistence
/system-property=org.kie.server.persistence.ds:add(value=java:/rhpamXADS)
/system-property=org.kie.server.persistence.dialect:add(value=org.hibernate.dialect.PostgreSQLDialect)

#EJB Timer configuration
/subsystem=ejb3/service=timer-service/database-data-store=ejb_timer_ds:add(datasource-jndi-name="java:/rhpamXADS",database="postgresql",partition=ejb_timer_part,refresh-interval="1000")
/subsystem=ejb3/service=timer-service:write-attribute(name="default-data-store", value="ejb_timer_ds")
/subsystem=ejb3/service=timer-service/file-data-store=default-file-store:remove

stop-embedded-server